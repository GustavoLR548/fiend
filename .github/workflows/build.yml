name: Build Fiend

on:
  push:
    branches: [ master, main, feat/*, dev ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-linux-bundled:
    name: Build on Linux (Bundled Allegro)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive 
    
    - name: Install build dependencies only
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libx11-dev \
          libxext-dev \
          libxcursor-dev \
          libxxf86vm-dev \
          libasound2-dev \
          libpulse-dev
    
    - name: Verify submodule
      run: |
        cd external/allegro4
        git describe --tags
        cd ../..
    
    - name: Build bundled Allegro 4.4.3.1
      run: |
        cd external/allegro4
        mkdir -p build
        cd build
        
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX="$PWD/install" \
          -DSHARED=ON \
          -DWANT_DOCS=OFF \
          -DWANT_EXAMPLES=OFF \
          -DWANT_TOOLS=OFF \
          -DWANT_TESTS=OFF \
          -DWANT_ALLEGROGL=OFF \
          -DWANT_LOADPNG=OFF \
          -DWANT_LOGG=OFF \
          -DWANT_JPGALLEG=OFF
        
        make -j$(nproc)
        make install
        cd ../../..
    
    - name: Configure Fiend with bundled Allegro
      run: |
        mkdir -p build
        cd build
        
        export PKG_CONFIG_PATH="$PWD/../external/allegro4/build/install/lib/pkgconfig:$PKG_CONFIG_PATH"
        export ALLEGRO_LIB_DIR="$PWD/../external/allegro4/build/install/lib"
        
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_BUNDLED_ALLEGRO=OFF \
          -DCMAKE_LIBRARY_PATH="${ALLEGRO_LIB_DIR}" \
          -DCMAKE_PREFIX_PATH="$PWD/../external/allegro4/build/install"
    
    - name: Build Fiend
      run: |
        cd build
        export PKG_CONFIG_PATH="$PWD/../external/allegro4/build/install/lib/pkgconfig:$PKG_CONFIG_PATH"
        export ALLEGRO_LIB_DIR="$PWD/../external/allegro4/build/install/lib"
        export LD_LIBRARY_PATH="${ALLEGRO_LIB_DIR}:${LD_LIBRARY_PATH}"
        export LIBRARY_PATH="${ALLEGRO_LIB_DIR}:${LIBRARY_PATH}"
        
        make -j$(nproc) VERBOSE=1
    
    - name: Bundle Allegro library with executables
      run: |
        mkdir -p release/lib
        cp external/allegro4/build/install/lib/liballeg*.so* release/lib/
        
        cat > release/fiend.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/fiend" "$@"
        EOF
        
        cat > release/mapeditor.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/mapeditor" "$@"
        EOF
        
        chmod +x release/fiend.sh release/mapeditor.sh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fiend-linux-x64-bundled
        path: |
          release/fiend
          release/fiend.sh
          release/mapeditor
          release/mapeditor.sh
          release/lib/
          release/data/
          release/graphic/
          release/maps/
          release/music/
          release/sound/
          release/readme.txt
        if-no-files-found: error

  build-windows-legacy:
    name: Build on Windows (MinGW 6.3.0 + DX8)
    runs-on: windows-2019
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    - name: Setup MinGW 6.3.0 and DX8 (From Repo)
      shell: powershell
      run: |
        Write-Host "Extracting tools..."
        # Use 7z to extract. The '&' operator runs the command in PowerShell.
        & "C:\Program Files\7-Zip\7z.exe" x build_tools\mingw.7z -oC:\ -y
        & "C:\Program Files\7-Zip\7z.exe" x build_tools\dx80_mgw.zip -oC:\DX8 -y
        
        Write-Host "Configuring MinGW..."
        # Add MinGW bin to the system PATH for future steps
        "C:\mingw32\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        
        Write-Host "Injecting DX8 into MinGW..."
        # We copy DX8 headers/libs to BOTH locations GCC might check.
        # This fixes the "Could NOT find DDRAW" error.
        $targets = @(
            "C:\mingw32",
            "C:\mingw32\i686-w64-mingw32"
        )
        
        foreach ($target in $targets) {
            Write-Host "Injecting into $target..."
            Copy-Item -Path "C:\DX8\include\*" -Destination "$target\include" -Recurse -Force
            Copy-Item -Path "C:\DX8\lib\*" -Destination "$target\lib" -Recurse -Force
        }

    - name: Verify Environment
      shell: cmd
      run: |
        gcc --version
        mingw32-make --version
        echo "Checking for ddraw.h..."
        if exist C:\mingw32\include\ddraw.h echo "Found in local include"
        if exist C:\mingw32\i686-w64-mingw32\include\ddraw.h echo "Found in system include"
    
    - name: Build bundled Allegro 4.4.3.1
      run: |
        cd external/allegro4
        mkdir build
        cd build
        
        # Explicitly use MinGW Makefiles generator
        cmake .. -G "MinGW Makefiles" `
          -DCMAKE_C_COMPILER=gcc `
          -DCMAKE_CXX_COMPILER=g++ `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_INSTALL_PREFIX="$PWD/install" `
          -DSHARED=ON `
          -DWANT_DOCS=OFF `
          -DWANT_EXAMPLES=OFF `
          -DWANT_TOOLS=OFF `
          -DWANT_TESTS=OFF `
          -DWANT_ALLEGROGL=OFF `
          -DWANT_LOADPNG=OFF `
          -DWANT_LOGG=OFF `
          -DWANT_JPGALLEG=OFF
        
        mingw32-make -j2
        mingw32-make install
    
    - name: Configure Fiend
      run: |
        mkdir build
        cd build
        
        $env:ALLEGRO_ROOT = "$PWD/../external/allegro4/build/install"
        $env:ALLEGRO_INCLUDE_DIR = "$env:ALLEGRO_ROOT/include"
        
        # We need to point to the .dll.a (import library)
        $env:ALLEGRO_LIBRARY = "$env:ALLEGRO_ROOT/lib/liballeg44.dll.a"
        
        cmake .. -G "MinGW Makefiles" `
          -DCMAKE_C_COMPILER=gcc `
          -DCMAKE_CXX_COMPILER=g++ `
          -DCMAKE_BUILD_TYPE=Release `
          -DUSE_BUNDLED_ALLEGRO=OFF `
          -DALLEGRO_INCLUDE_DIR="$env:ALLEGRO_INCLUDE_DIR" `
          -DALLEGRO_LIBRARY="$env:ALLEGRO_LIBRARY" `
          -DCMAKE_PREFIX_PATH="$env:ALLEGRO_ROOT"
    
    - name: Build Fiend
      run: |
        cd build
        mingw32-make -j2
    
    - name: Bundle DLLs and Assets
      run: |
        mkdir release/lib
        
        # Copy Allegro DLL
        copy external\allegro4\build\install\bin\*.dll release\
        
        # Copy GCC/MinGW Runtime DLLs
        # Since we are not in MSYS2, we verify which DLLs are needed
        # Usually: libgcc_s_dw2-1.dll, libstdc++-6.dll, libwinpthread-1.dll
        copy C:\mingw32\bin\libgcc_s_dw2-1.dll release\
        copy C:\mingw32\bin\libstdc++-6.dll release\
        copy C:\mingw32\bin\libwinpthread-1.dll release\
        
        dir release\*.dll
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fiend-windows-x86-bundled
        path: |
          release/fiend.exe
          release/mapeditor.exe
          release/*.dll
          release/data/
          release/graphic/
          release/maps/
          release/music/
          release/sound/
          release/readme.txt
        if-no-files-found: error

  create-release:
    name: Create Release
    needs: [build-linux-bundled, build-windows-legacy]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate version number
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          BUILD_NUMBER=$(git rev-list --count HEAD)
          DATE=$(date +%Y.%m.%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="nightly-${DATE}-build${BUILD_NUMBER}-${SHORT_SHA}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: fiend-linux-x64-bundled
        path: fiend-linux-x64-bundled
    
    - name: Download Windows artifacts (32-bit Legacy)
      uses: actions/download-artifact@v4
      with:
        name: fiend-windows-x86-bundled
        path: fiend-windows-x86-bundled
    
    - name: Create release archives
      run: |
        # Linux
        mkdir -p fiend-linux-bundled-release
        cp -r fiend-linux-x64-bundled/* fiend-linux-bundled-release/
        cd fiend-linux-bundled-release
        zip -r ../fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip .
        cd ..
        
        # Windows (Legacy x86)
        mkdir -p fiend-windows-bundled-release
        cp -r fiend-windows-x86-bundled/* fiend-windows-bundled-release/
        cd fiend-windows-bundled-release
        
        cat > README.txt << 'EOF'
        Fiend - Windows Legacy Release
        ================================
        Built with MinGW 6.3.0 and DirectX 8 SDK for maximum compatibility.
        
        1. Extract archive
        2. Run fiend.exe
        EOF
        
        zip -r ../fiend-windows-x86-bundled-${{ steps.version.outputs.VERSION }}.zip .
        cd ..
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: Fiend Build ${{ steps.version.outputs.VERSION }}
        files: |
          fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip
          fiend-windows-x86-bundled-${{ steps.version.outputs.VERSION }}.zip
