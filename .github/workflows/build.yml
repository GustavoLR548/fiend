name: Build Fiend

on:
  push:
    branches: [ master, main, feat/*, dev ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build on Linux (System Allegro)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for version calculation
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          liballegro4-dev \
          libx11-dev \
          libxext-dev \
          libxcursor-dev \
          libxxf86vm-dev
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: |
        cd build
        make -j$(nproc)
    
    - name: Check binaries
      run: |
        ls -lh release/fiend
        ls -lh release/mapeditor
        file release/fiend
        file release/mapeditor
        ldd release/fiend | grep allegro
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fiend-linux-x64-system
        path: |
          release/fiend
          release/mapeditor
          release/data/
          release/graphic/
          release/maps/
          release/music/
          release/sound/
          release/readme.txt
        if-no-files-found: error

  build-linux-bundled:
    name: Build on Linux (Bundled Allegro)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive  # Critical: Initialize submodules
    
    - name: Install build dependencies only
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libx11-dev \
          libxext-dev \
          libxcursor-dev \
          libxxf86vm-dev \
          libasound2-dev \
          libpulse-dev
        # Note: NOT installing liballegro4-dev - we'll build it ourselves
    
    - name: Verify submodule
      run: |
        echo "Checking Allegro submodule..."
        cd external/allegro4
        git describe --tags
        ls -la CMakeLists.txt
        cd ../..
    
    - name: Build bundled Allegro 4.4.3.1
      run: |
        echo "Building Allegro from submodule..."
        cd external/allegro4
        mkdir -p build
        cd build
        
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX="$PWD/install" \
          -DSHARED=ON \
          -DWANT_DOCS=OFF \
          -DWANT_EXAMPLES=OFF \
          -DWANT_TOOLS=OFF \
          -DWANT_TESTS=OFF
        
        make -j$(nproc)
        make install
        
        echo "Allegro built and installed to: $PWD/install"
        ls -la install/lib/
        cd ../../..
    
    - name: Configure Fiend with bundled Allegro
      run: |
        mkdir -p build
        cd build
        
        # Set PKG_CONFIG_PATH to find our bundled Allegro
        export PKG_CONFIG_PATH="$PWD/../external/allegro4/build/install/lib/pkgconfig:$PKG_CONFIG_PATH"
        
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_BUNDLED_ALLEGRO=OFF
        
        # Note: USE_BUNDLED_ALLEGRO=OFF because pkg-config will find our bundled version
    
    - name: Build Fiend
      run: |
        cd build
        make -j$(nproc) VERBOSE=1
    
    - name: Check binaries and dependencies
      run: |
        echo "=== Fiend binary ==="
        ls -lh release/fiend
        file release/fiend
        echo ""
        echo "=== Allegro dependency ==="
        ldd release/fiend | grep allegro
        echo ""
        echo "=== Mapeditor binary ==="
        ls -lh release/mapeditor
        file release/mapeditor
        ldd release/mapeditor | grep allegro
    
    - name: Bundle Allegro library with executables
      run: |
        echo "Copying bundled Allegro library..."
        mkdir -p release/lib
        cp external/allegro4/build/install/lib/liballeg*.so* release/lib/
        
        # Create wrapper scripts that set LD_LIBRARY_PATH
        cat > release/fiend.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/fiend" "$@"
        EOF
        
        cat > release/mapeditor.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/mapeditor" "$@"
        EOF
        
        chmod +x release/fiend.sh release/mapeditor.sh
        
        echo "Bundled library structure:"
        ls -lh release/lib/
    
    - name: Test bundled build
      run: |
        cd release
        export LD_LIBRARY_PATH="$PWD/lib:${LD_LIBRARY_PATH}"
        echo "Testing fiend --version (if supported)..."
        ./fiend --help || echo "Fiend executable ready"
        echo "Testing mapeditor..."
        ./mapeditor --help || echo "Mapeditor executable ready"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fiend-linux-x64-bundled
        path: |
          release/fiend
          release/fiend.sh
          release/mapeditor
          release/mapeditor.sh
          release/lib/
          release/data/
          release/graphic/
          release/maps/
          release/music/
          release/sound/
          release/readme.txt
        if-no-files-found: error

  build-linux-ubuntu-22:
    name: Build on Ubuntu 22.04
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          liballegro4-dev \
          libx11-dev \
          libxext-dev \
          libxcursor-dev \
          libxxf86vm-dev
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: |
        cd build
        make -j$(nproc)
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fiend-linux-ubuntu22-x64
        path: |
          release/fiend
          release/mapeditor
        if-no-files-found: error

  # Note: macOS and Windows builds would require significant porting work
  # Allegro 4 is available on macOS via Homebrew but may need adjustments
  # Windows would need either Allegro 4 Windows binaries or migration to Allegro 5
  
  # Uncomment when ready for cross-platform testing
  # build-macos:
  #   name: Build on macOS
  #   runs-on: macos-latest
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     
  #   - name: Install dependencies
  #     run: |
  #       brew install allegro cmake
  #   
  #   - name: Configure CMake
  #     run: |
  #       mkdir -p build
  #       cd build
  #       cmake .. -DCMAKE_BUILD_TYPE=Release
  #   
  #   - name: Build
  #     run: |
  #       cd build
  #       make -j$(sysctl -n hw.ncpu)
  #   
  #   - name: Upload artifacts
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: fiend-macos-x64
  #       path: |
  #         release/fiend
  #         release/mapeditor

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-tidy
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance,portability \
          --suppress=missingIncludeSystem \
          --inline-suppr \
          --error-exitcode=0 \
          src/ 2>&1 | tee cppcheck-report.txt
    
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: static-analysis-results
        path: cppcheck-report.txt

  create-release:
    name: Create Release
    needs: [build-linux, build-linux-bundled, build-linux-ubuntu-22]
    runs-on: ubuntu-latest
    # Only create releases for master/main branch or version tags
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate version number
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # If it's a tag, use the tag name
          VERSION=${GITHUB_REF#refs/tags/}
        else
          # Auto-generate version based on date and commit count
          BUILD_NUMBER=$(git rev-list --count HEAD)
          DATE=$(date +%Y.%m.%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="nightly-${DATE}-build${BUILD_NUMBER}-${SHORT_SHA}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"
    
    - name: Download Linux artifacts (system)
      uses: actions/download-artifact@v4
      with:
        name: fiend-linux-x64-system
        path: fiend-linux-x64-system
    
    - name: Download Linux artifacts (bundled)
      uses: actions/download-artifact@v4
      with:
        name: fiend-linux-x64-bundled
        path: fiend-linux-x64-bundled
    
    - name: Download Ubuntu 22.04 artifacts
      uses: actions/download-artifact@v4
      with:
        name: fiend-linux-ubuntu22-x64
        path: fiend-linux-ubuntu22-x64
    
    - name: Create release archives
      run: |
        # Create bundled release (recommended - includes Allegro)
        echo "Creating bundled release..."
        mkdir -p fiend-bundled-release
        cp -r fiend-linux-x64-bundled/* fiend-bundled-release/
        
        cd fiend-bundled-release
        
        # Create README for bundled release
        cat > README.txt << 'EOF'
        Fiend - Bundled Release
        =======================
        
        This release includes a bundled version of Allegro 4.4.3.1.
        It should work on most modern Linux distributions without installing Allegro separately.
        
        To run:
        1. Extract this archive
        2. Run: ./fiend.sh (for the game)
        3. Run: ./mapeditor.sh (for the map editor)
        
        The wrapper scripts (.sh) set up the library path automatically.
        
        System Requirements:
        - Linux x86_64
        - X11
        - ALSA or PulseAudio
        - glibc 2.31+ (Ubuntu 20.04+, similar distributions)
        
        EOF
        
        zip -r ../fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip .
        tar -czf ../fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.tar.gz .
        cd ..
        
        # Create system release (requires system Allegro)
        echo "Creating system release..."
        mkdir -p fiend-system-release
        cp -r fiend-linux-x64-system/* fiend-system-release/
        
        cd fiend-system-release
        
        cat > README.txt << 'EOF'
        Fiend - System Allegro Release
        ===============================
        
        This release requires Allegro 4 to be installed on your system.
        
        To install Allegro 4:
        - Ubuntu/Debian: sudo apt-get install liballegro4-dev
        - Fedora: sudo dnf install allegro-devel
        
        To run:
        1. Extract this archive
        2. Run: ./fiend (for the game)
        3. Run: ./mapeditor (for the map editor)
        
        EOF
        
        zip -r ../fiend-linux-x64-system-${{ steps.version.outputs.VERSION }}.zip .
        tar -czf ../fiend-linux-x64-system-${{ steps.version.outputs.VERSION }}.tar.gz .
        cd ..
        
        # Create minimal binary-only archive for Ubuntu 22.04
        echo "Creating Ubuntu 22.04 release..."
        mkdir -p fiend-ubuntu22
        cp fiend-linux-ubuntu22-x64/fiend fiend-ubuntu22/
        cp fiend-linux-ubuntu22-x64/mapeditor fiend-ubuntu22/
        cp -r fiend-linux-x64-system/data fiend-ubuntu22/
        cp -r fiend-linux-x64-system/graphic fiend-ubuntu22/
        cp -r fiend-linux-x64-system/maps fiend-ubuntu22/
        cp -r fiend-linux-x64-system/music fiend-ubuntu22/
        cp -r fiend-linux-x64-system/sound fiend-ubuntu22/
        cp fiend-linux-x64-system/readme.txt fiend-ubuntu22/
        
        cd fiend-ubuntu22
        zip -r ../fiend-linux-ubuntu22-x64-${{ steps.version.outputs.VERSION }}.zip .
        cd ..
    
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: ${{ startsWith(github.ref, 'refs/tags/') && format('Fiend {0}', steps.version.outputs.VERSION) || format('Fiend Build {0}', steps.version.outputs.VERSION) }}
        body: |
          ${{ startsWith(github.ref, 'refs/tags/') && 'Stable release' || 'Automated nightly build' }}
          
          **Build Date:** ${{ steps.version.outputs.DATE }}
          **Commit:** ${{ steps.version.outputs.SHORT_SHA }}
          **Branch:** ${{ github.ref_name }}
          
          ## Downloads
          
          ### Recommended: Bundled Release (includes Allegro)
          - `fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip` - **RECOMMENDED** - Complete package with bundled Allegro 4.4.3.1
          - `fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.tar.gz` - Same as above, tar.gz format
          
          ### System Allegro Release (requires liballegro4-dev)
          - `fiend-linux-x64-system-${{ steps.version.outputs.VERSION }}.zip` - Uses system Allegro (smaller download)
          - `fiend-linux-x64-system-${{ steps.version.outputs.VERSION }}.tar.gz` - Same as above, tar.gz format
          
          ### Ubuntu 22.04 Specific
          - `fiend-linux-ubuntu22-x64-${{ steps.version.outputs.VERSION }}.zip` - Built on Ubuntu 22.04 LTS
          
          ## How to Run
          
          ### Bundled Release (Recommended):
          1. Extract the archive
          2. Run `./fiend.sh` to start the game or `./mapeditor.sh` to edit maps
          
          ### System Release:
          1. Install Allegro 4: `sudo apt-get install liballegro4-dev`
          2. Extract the archive
          3. Run `./fiend` to start the game or `./mapeditor` to edit maps
          
          ## Preservation Notes
          The bundled release demonstrates our preservation strategy - it includes Allegro 4.4.3.1 source code built from the git submodule. This ensures the game can run even if system packages become unavailable.
          
          ## Changes
          See commit history for details.
        files: |
          fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip
          fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.tar.gz
          fiend-linux-x64-system-${{ steps.version.outputs.VERSION }}.zip
          fiend-linux-x64-system-${{ steps.version.outputs.VERSION }}.tar.gz
          fiend-linux-ubuntu22-x64-${{ steps.version.outputs.VERSION }}.zip
        draft: false
        prerelease: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
