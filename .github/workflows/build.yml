name: Build Fiend

on:
  push:
    branches: [ master, main, feat/*, dev ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-linux-bundled:
    name: Build on Linux (Bundled Allegro)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive  # Critical: Initialize submodules
    
    - name: Install build dependencies only
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libx11-dev \
          libxext-dev \
          libxcursor-dev \
          libxxf86vm-dev \
          libasound2-dev \
          libpulse-dev
        # Note: NOT installing liballegro4-dev - we'll build it ourselves
    
    - name: Verify submodule
      run: |
        echo "Checking Allegro submodule..."
        cd external/allegro4
        git describe --tags
        ls -la CMakeLists.txt
        cd ../..
    
    - name: Build bundled Allegro 4.4.3.1
      run: |
        echo "Building Allegro from submodule..."
        cd external/allegro4
        mkdir -p build
        cd build
        
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX="$PWD/install" \
          -DSHARED=ON \
          -DWANT_DOCS=OFF \
          -DWANT_EXAMPLES=OFF \
          -DWANT_TOOLS=OFF \
          -DWANT_TESTS=OFF \
          -DWANT_ALLEGROGL=OFF \
          -DWANT_LOADPNG=OFF \
          -DWANT_LOGG=OFF \
          -DWANT_JPGALLEG=OFF
        
        make -j$(nproc)
        make install
        
        echo "=== Allegro built and installed ==="
        echo "Install directory: $PWD/install"
        echo ""
        echo "=== Library files ==="
        ls -la install/lib/
        echo ""
        echo "=== pkg-config files ==="
        ls -la install/lib/pkgconfig/
        echo ""
        echo "=== allegro.pc content ==="
        cat install/lib/pkgconfig/allegro.pc || echo "allegro.pc not found"
        cd ../../..
    
    - name: Configure Fiend with bundled Allegro
      run: |
        mkdir -p build
        cd build
        
        # Set paths to find our bundled Allegro
        export PKG_CONFIG_PATH="$PWD/../external/allegro4/build/install/lib/pkgconfig:$PKG_CONFIG_PATH"
        export ALLEGRO_LIB_DIR="$PWD/../external/allegro4/build/install/lib"
        
        # Verify pkg-config can find Allegro
        echo "=== Testing pkg-config ==="
        echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
        echo ""
        pkg-config --modversion allegro || echo "ERROR: pkg-config cannot find allegro"
        pkg-config --libs allegro || echo "ERROR: pkg-config --libs failed"
        pkg-config --cflags allegro || echo "ERROR: pkg-config --cflags failed"
        echo ""
        
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_BUNDLED_ALLEGRO=OFF \
          -DCMAKE_LIBRARY_PATH="${ALLEGRO_LIB_DIR}" \
          -DCMAKE_PREFIX_PATH="$PWD/../external/allegro4/build/install"
        
        # Note: USE_BUNDLED_ALLEGRO=OFF because pkg-config will find our bundled version
        # RPATH is configured in CMakeLists.txt to look for libraries in ./lib/ relative to executable
    
    - name: Build Fiend
      run: |
        cd build
        
        # Set library path for linking
        export PKG_CONFIG_PATH="$PWD/../external/allegro4/build/install/lib/pkgconfig:$PKG_CONFIG_PATH"
        export ALLEGRO_LIB_DIR="$PWD/../external/allegro4/build/install/lib"
        export LD_LIBRARY_PATH="${ALLEGRO_LIB_DIR}:${LD_LIBRARY_PATH}"
        export LIBRARY_PATH="${ALLEGRO_LIB_DIR}:${LIBRARY_PATH}"
        
        make -j$(nproc) VERBOSE=1
    
    - name: Check binaries and dependencies
      run: |
        echo "=== Fiend binary ==="
        ls -lh release/fiend
        file release/fiend
        echo ""
        echo "=== RPATH check ==="
        readelf -d release/fiend | grep -i rpath || echo "No RPATH set"
        echo ""
        echo "=== Allegro dependency (may fail if lib not in path yet) ==="
        ldd release/fiend | grep allegro || echo "Library will be found via RPATH at runtime"
        echo ""
        echo "=== Mapeditor binary ==="
        ls -lh release/mapeditor
        file release/mapeditor
        echo ""
        echo "=== RPATH check ==="
        readelf -d release/mapeditor | grep -i rpath || echo "No RPATH set"
        echo ""
        ldd release/mapeditor | grep allegro || echo "Library will be found via RPATH at runtime"
    
    - name: Bundle Allegro library with executables
      run: |
        echo "Copying bundled Allegro library..."
        mkdir -p release/lib
        cp external/allegro4/build/install/lib/liballeg*.so* release/lib/
        
        # Create wrapper scripts that set LD_LIBRARY_PATH
        cat > release/fiend.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/fiend" "$@"
        EOF
        
        cat > release/mapeditor.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/mapeditor" "$@"
        EOF
        
        chmod +x release/fiend.sh release/mapeditor.sh
        
        echo "Bundled library structure:"
        ls -lh release/lib/
    
    - name: Test bundled build
      run: |
        cd release
        
        echo "=== Verifying RPATH works with bundled libraries ==="
        echo "Contents of ./lib/:"
        ls -lh lib/
        echo ""
        
        echo "=== Detailed RPATH check ==="
        readelf -d fiend | grep -E '(RPATH|RUNPATH|NEEDED)'
        echo ""
        
        echo "=== LDD check from release directory ==="
        ldd fiend
        echo ""
        
        echo "=== RPATH verification complete ==="
        echo "Note: Skipping executable test as it requires game assets to initialize"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fiend-linux-x64-bundled
        path: |
          release/fiend
          release/fiend.sh
          release/mapeditor
          release/mapeditor.sh
          release/lib/
          release/data/
          release/graphic/
          release/maps/
          release/music/
          release/sound/
          release/readme.txt
        if-no-files-found: error

  build-windows-bundled:
    name: Build on Windows (Bundled Allegro)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Set up MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          make
          git
    
    - name: Verify submodule
      shell: msys2 {0}
      run: |
        echo "Checking Allegro submodule..."
        cd external/allegro4
        git describe --tags
        ls -la CMakeLists.txt
        cd ../..
    
    - name: Build bundled Allegro 4.4.3.1
      shell: msys2 {0}
      run: |
        echo "Building Allegro from submodule..."
        cd external/allegro4
        mkdir -p build
        cd build
        
        cmake .. \
          -G "Ninja" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX="$PWD/install" \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          -DSHARED=ON \
          -DWANT_DOCS=OFF \
          -DWANT_EXAMPLES=OFF \
          -DWANT_TOOLS=OFF \
          -DWANT_TESTS=OFF \
          -DWANT_ALLEGROGL=OFF \
          -DWANT_LOADPNG=OFF \
          -DWANT_LOGG=OFF \
          -DWANT_JPGALLEG=OFF
        
        ninja
        ninja install
        
        echo "=== Allegro built and installed ==="
        echo "Install directory: $PWD/install"
        echo ""
        echo "=== Library files ==="
        ls -la install/lib/ || ls -la install/bin/
        echo ""
        echo "=== pkg-config files ==="
        ls -la install/lib/pkgconfig/ || echo "No pkgconfig directory"
        cd ../../..
    
    - name: Configure Fiend with bundled Allegro
      shell: msys2 {0}
      run: |
        mkdir -p build
        cd build
        
        # Set paths to find our bundled Allegro
        ALLEGRO_ROOT="$(cygpath -u "$PWD/../external/allegro4/build/install")"
        ALLEGRO_INCLUDE_DIR="${ALLEGRO_ROOT}/include"
        ALLEGRO_LIBRARY_DIR="${ALLEGRO_ROOT}/lib"
        
        echo "=== Allegro paths ==="
        echo "ALLEGRO_ROOT=${ALLEGRO_ROOT}"
        echo "ALLEGRO_INCLUDE_DIR=${ALLEGRO_INCLUDE_DIR}"
        echo "ALLEGRO_LIBRARY_DIR=${ALLEGRO_LIBRARY_DIR}"
        echo ""
        echo "Include directory contents:"
        ls -la "${ALLEGRO_INCLUDE_DIR}"
        echo ""
        echo "Library directory contents:"
        ls -la "${ALLEGRO_LIBRARY_DIR}"
        echo ""
        
        cmake .. \
          -G "Ninja" \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_BUNDLED_ALLEGRO=OFF \
          -DALLEGRO_INCLUDE_DIR="${ALLEGRO_INCLUDE_DIR}" \
          -DALLEGRO_LIBRARY="${ALLEGRO_LIBRARY_DIR}/liballeg44.dll.a" \
          -DCMAKE_PREFIX_PATH="${ALLEGRO_ROOT}"
    
    - name: Build Fiend
      shell: msys2 {0}
      run: |
        cd build
        
        # Set library path for linking
        ALLEGRO_ROOT="$(cygpath -u "$PWD/../external/allegro4/build/install")"
        export PATH="${ALLEGRO_ROOT}/bin:$PATH"
        
        ninja -v
    
    - name: Check binaries and dependencies
      shell: msys2 {0}
      run: |
        echo "=== Fiend binary ==="
        ls -lh release/fiend.exe
        file release/fiend.exe || echo "file command not available"
        echo ""
        echo "=== Allegro dependency ==="
        ldd release/fiend.exe | grep -i allegro || echo "Library dependencies checked"
        echo ""
        echo "=== Mapeditor binary ==="
        ls -lh release/mapeditor.exe
        file release/mapeditor.exe || echo "file command not available"
        echo ""
        ldd release/mapeditor.exe | grep -i allegro || echo "Library dependencies checked"
    
    - name: Bundle Allegro library with executables
      shell: msys2 {0}
      run: |
        echo "Copying bundled Allegro DLLs..."
        mkdir -p release/lib
        
        # Copy Allegro DLLs from build/install
        cp external/allegro4/build/install/bin/*.dll release/ || cp external/allegro4/build/install/lib/*.dll release/ || echo "DLLs copied"
        
        # Copy MinGW runtime DLLs that the executables depend on
        mingw_bin="/mingw64/bin"
        if [ -d "$mingw_bin" ]; then
          for dll in $(ldd release/fiend.exe | grep mingw64 | awk '{print $3}'); do
            if [ -f "$dll" ]; then
              cp "$dll" release/
            fi
          done
        fi
        
        echo "Bundled library structure:"
        ls -lh release/*.dll || echo "DLLs listed"
    
    - name: Test bundled build
      shell: msys2 {0}
      run: |
        cd release
        
        echo "=== Verifying DLLs are present ==="
        ls -lh *.dll
        echo ""
        
        echo "=== DLL dependencies ==="
        ldd fiend.exe
        echo ""
        echo "=== Bundled build complete ==="
        echo "Note: Skipping executable test as it requires game assets to initialize"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fiend-windows-x64-bundled
        path: |
          release/fiend.exe
          release/mapeditor.exe
          release/*.dll
          release/data/
          release/graphic/
          release/maps/
          release/music/
          release/sound/
          release/readme.txt
        if-no-files-found: error

  create-release:
    name: Create Release
    needs: [build-linux-bundled, build-windows-bundled]
    runs-on: ubuntu-latest
    # Only create releases for master/main branch or version tags
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate version number
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # If it's a tag, use the tag name
          VERSION=${GITHUB_REF#refs/tags/}
        else
          # Auto-generate version based on date and commit count
          BUILD_NUMBER=$(git rev-list --count HEAD)
          DATE=$(date +%Y.%m.%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="nightly-${DATE}-build${BUILD_NUMBER}-${SHORT_SHA}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"
    
    - name: Download Linux artifacts (bundled)
      uses: actions/download-artifact@v4
      with:
        name: fiend-linux-x64-bundled
        path: fiend-linux-x64-bundled
    
    - name: Download Windows artifacts (bundled)
      uses: actions/download-artifact@v4
      with:
        name: fiend-windows-x64-bundled
        path: fiend-windows-x64-bundled
    
    - name: Create release archives
      run: |
        # Create bundled Linux release (includes Allegro)
        echo "Creating Linux bundled release..."
        mkdir -p fiend-linux-bundled-release
        cp -r fiend-linux-x64-bundled/* fiend-linux-bundled-release/
        
        cd fiend-linux-bundled-release
        
        # Create README for bundled release
        cat > README.txt << 'EOF'
        Fiend - Linux Bundled Release
        ==============================
        
        This release includes a bundled version of Allegro 4.4.3.1.
        It should work on most modern Linux distributions without installing Allegro separately.
        
        To run:
        1. Extract this archive
        2. Run: ./fiend.sh (for the game)
        3. Run: ./mapeditor.sh (for the map editor)
        
        The wrapper scripts (.sh) set up the library path automatically.
        
        System Requirements:
        - Linux x86_64
        - X11
        - ALSA or PulseAudio
        - glibc 2.31+ (Ubuntu 20.04+, similar distributions)
        
        EOF
        
        zip -r ../fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip .
        tar -czf ../fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.tar.gz .
        cd ..
        
        # Create bundled Windows release (includes Allegro)
        echo "Creating Windows bundled release..."
        mkdir -p fiend-windows-bundled-release
        cp -r fiend-windows-x64-bundled/* fiend-windows-bundled-release/
        
        cd fiend-windows-bundled-release
        
        cat > README.txt << 'EOF'
        Fiend - Windows Bundled Release
        ================================
        
        This release includes a bundled version of Allegro 4.4.3.1 and all required DLLs.
        It should work on most modern Windows systems without installing anything.
        
        To run:
        1. Extract this archive
        2. Double-click fiend.exe to start the game
        3. Double-click mapeditor.exe to edit maps
        
        System Requirements:
        - Windows 7 or later (x64)
        - DirectX compatible graphics
        
        EOF
        
        zip -r ../fiend-windows-x64-bundled-${{ steps.version.outputs.VERSION }}.zip .
        cd ..
    
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: ${{ startsWith(github.ref, 'refs/tags/') && format('Fiend {0}', steps.version.outputs.VERSION) || format('Fiend Build {0}', steps.version.outputs.VERSION) }}
        body: |
          ${{ startsWith(github.ref, 'refs/tags/') && 'Stable release' || 'Automated nightly build' }}
          
          **Build Date:** ${{ steps.version.outputs.DATE }}
          **Commit:** ${{ steps.version.outputs.SHORT_SHA }}
          **Branch:** ${{ github.ref_name }}
          
          ## Downloads
          
          ### Linux (Bundled Allegro)
          - `fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip` - Complete package with bundled Allegro 4.4.3.1
          - `fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.tar.gz` - Same as above, tar.gz format
          
          ### Windows (Bundled Allegro)
          - `fiend-windows-x64-bundled-${{ steps.version.outputs.VERSION }}.zip` - Complete package with bundled Allegro 4.4.3.1 and all DLLs
          
          ## How to Run
          
          ### Linux:
          1. Extract the archive
          2. Run `./fiend.sh` to start the game or `./mapeditor.sh` to edit maps
          
          ### Windows:
          1. Extract the archive
          2. Double-click `fiend.exe` to start the game or `mapeditor.exe` to edit maps
          
          ## Preservation Notes
          Both releases include Allegro 4.4.3.1 built from the git submodule. This ensures the game can run even if system packages become unavailable. The builds are fully self-contained and portable.
          
          ## Changes
          See commit history for details.
        files: |
          fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.zip
          fiend-linux-x64-bundled-${{ steps.version.outputs.VERSION }}.tar.gz
          fiend-windows-x64-bundled-${{ steps.version.outputs.VERSION }}.zip
        draft: false
        prerelease: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
